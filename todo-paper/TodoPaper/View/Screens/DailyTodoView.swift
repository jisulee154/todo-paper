//
//  DailyTodoView.swift
//  todo-paper
//
//  Created by Ïù¥ÏßÄÏàò on 2023/07/07.
//

import SwiftUI
import CoreData
import Combine

struct DailyTodoView: View {
    
    //MARK: - Shared Data
    @Environment(\.managedObjectContext) private var viewContext
    //    @StateObject var todayTodoViewModel: TodoViewModel = TodoViewModel()
    //    @StateObject var previousTodoViewModel: TodoViewModel = TodoViewModel()
    @StateObject var todoViewModel: TodoViewModel = TodoViewModel()
    @StateObject var detailTodoViewModel: DetailTodoViewModel = DetailTodoViewModel()
    
    //MARK: - View
    var body: some View {
        ZStack {
            VStack {
                //MARK: - Calendar Scroll
                DateHeader(todoViewModel: todoViewModel)
                if todoViewModel.todos.count > 0 {
                    //MARK: - Todo list
                    List {
                        Section("list") {
                            VStack {
                                ForEach(todoViewModel.todos) { todo in
                                    TodoItemRow(with: TodoItem(uuid: todo.uuid,
                                                               title: todo.title,
                                                               duedate: todo.duedate,
                                                               status: todo.status,
                                                               section: todo.section),
                                                todoViewModel: todoViewModel,
                                                todoItemRowType: TodoItemRowType.today,
                                                detailTodoViewModel: detailTodoViewModel)
                                    
                                }
                            }
                            .overlay(
                                RoundedRectangle(cornerRadius: 10, style: .circular).stroke(Color.themeColor40, lineWidth: 2)
                            )
                        } // Section - Today
                        .listRowInsets(EdgeInsets.init())
                        
                        
                        // Î≥¥Ïó¨ÏßÄÎäî ÏùºÏûêÍ∞Ä Ïò§ÎäòÏù∏ Í≤ΩÏö∞ Í∏∞ÌïúÏù¥ ÏßÄÎÇú Ìà¨ÎëêÎ•º old ÏÑπÏÖòÏóê Ï∂úÎ†•ÌïúÎã§.
                        if todoViewModel.canShowOldTodos() {
                            Section("old") {
                                VStack {
                                    ForEach(todoViewModel.oldTodos) { todo in
                                        
                                        TodoItemRow(with: TodoItem(uuid: todo.uuid,
                                                                   title: todo.title,
                                                                   duedate: todo.duedate,
                                                                   status: todo.status,
                                                                   section: todo.section),
                                                    todoViewModel: todoViewModel,
                                                    todoItemRowType: TodoItemRowType.old,
                                                    detailTodoViewModel: detailTodoViewModel)
                                        
                                        Divider()
                                    }
                                }
                                .overlay(
                                    RoundedRectangle(cornerRadius: 10, style: .circular).stroke(Color.themeColor40, lineWidth: 2)
                                )
                            } // Section - Old
                            .listRowInsets(EdgeInsets.init())
                        }
                    } // List
                } else {
                    // Ìï¥Îãπ ÎÇ†ÏßúÏùò Ìà¨ÎëêÍ∞Ä ÏóÜÏùÑ Îïå
                    HStack {
                        Spacer()
                        VStack {
                            Spacer()
                            Text("""
                                   Ìà¨ÎëêÍ∞Ä ÌïòÎÇòÎèÑ ÏóÜÏñ¥Ïöî.\n
                                   ÌïòÎÇò Ï∂îÍ∞ÄÌï¥ Î≥ºÍπåÏöî? üìù
                                   """)
                            Spacer()
                        }
                        Spacer()
                    }
                    .overlay(
                        RoundedRectangle(cornerRadius: 15, style: .circular).stroke(Color.themeColor40, lineWidth: 1)
                    )
                    .padding(.all, 10)
                }
            }
            // Ìï†Ïùº Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
            .refreshable {
                todoViewModel.todos = todoViewModel.fetchTodosBySelectedDate()
                
                if todoViewModel.canShowOldTodos() {
                    todoViewModel.oldTodos = todoViewModel.fetchOldTodos()
                }
            }
            .onAppear {
                todoViewModel.searchDate = todoViewModel.setSearchDate(date: Date())
                //todoViewModel.scrollTargetDate = todoViewModel.setScrollTargetDate(with: Date())
                todoViewModel.todos = todoViewModel.fetchTodosBySelectedDate()
                
                if todoViewModel.canShowOldTodos() {
                    todoViewModel.oldTodos = todoViewModel.fetchOldTodos()
                }
            }
            
            
            //MARK: - Make New Todo Button & Complete Sticker
            FloatingFooter(todoViewModel: todoViewModel)
            
            
            //MARK: - Ìà¨Îëê Í∞úÎ≥Ñ ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÏãúÌä∏(ÌïòÎã®ÏóêÏÑú Ïä¨ÎùºÏù¥Îìú ÏóÖ)
            DetailTodoViewSheet(detailTodoViewModel: detailTodoViewModel, maxHeight: UIScreen.main.bounds.size.height / 1.8) {
//                Color.blue
                switch (detailTodoViewModel.timePosition) {
                case .past:
                    DetailTodoOfPast(detailTodoViewModel)
                case .today:
                    DetailTodoOfToday(detailTodoViewModel)
                case .future:
                    DetailTodoOfFuture(detailTodoViewModel)
                case .none:
                    Text("Time Position Error.")
                }
            }
            .edgesIgnoringSafeArea(.all)
            
            //MARK: - Date Picker
            if detailTodoViewModel.isDatePickerShowing {
                VStack {
                    Color.black
                        .opacity(0.3)
                        .frame(alignment: .top)
                        .onTapGesture {
                            detailTodoViewModel.isDatePickerShowing.toggle()
                        }
                        .edgesIgnoringSafeArea(.all)
                    VStack {
                        DatePicker(
                            "datepicker_1",
                            selection: $detailTodoViewModel.pickedDate,
                            displayedComponents: [.date]
                        )
                        .frame(width: 320, alignment: .center)
                        .datePickerStyle(.graphical)
                        .background(Color.clear)
                    }
                    .frame(width: UIScreen.main.bounds.size.width)
                    .background(Color.white)
                }
            }
        }
    }
}

//MARK: - ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÏãúÌä∏ (Í≥ºÍ±∞)
struct DetailTodoOfPast: View {
    @ObservedObject var detailTodoViewModel: DetailTodoViewModel
    
    init(_ detailTodoViewModel: DetailTodoViewModel) {
        self.detailTodoViewModel = detailTodoViewModel
    }
    
    var body: some View {
        VStack (spacing: 10) {
            HStack {
                Text("ÏÉÅÏÑ∏ ÏÑ§Ï†ï")
                    .font(.title)
                Spacer()
                Button {
                    detailTodoViewModel.isDetailSheetShowing = false
                } label: {
                    Image(systemName: "xmark")
                        .imageScale(.large)
                        .frame(width: 60, height: 40)
                }
                .foregroundColor(.themeColor40)
            }
            
            Button {
                //action
                print("ÎÇ†Ïßú Î≥ÄÍ≤Ω Î≤ÑÌäº ÎàÑÎ¶Ñ")
            } label: {
                Text("ÎÇ†Ïßú Î≥ÄÍ≤Ω")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Button {
                //action
            } label: {
                Text("Ïò§Îäò ÌïòÍ∏∞")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Spacer()
        }
        .padding(.horizontal, 20)
        .padding(.top, 30)
    }
}

//MARK: - ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÏãúÌä∏ (Ïò§Îäò)
struct DetailTodoOfToday: View {
    @ObservedObject var detailTodoViewModel: DetailTodoViewModel
    
    init(_ detailTodoViewModel: DetailTodoViewModel) {
        self.detailTodoViewModel = detailTodoViewModel
    }
    
    var body: some View {
        VStack (spacing: 10) {
            // Ï†úÎ™©Í≥º Ï∑®ÏÜå Î≤ÑÌäº
            HStack {
                Text("ÏÉÅÏÑ∏ ÏÑ§Ï†ï")
                    .font(.title)
                Spacer()
                Button {
                    detailTodoViewModel.isDetailSheetShowing = false
                } label: {
                    Image(systemName: "xmark")
                        .imageScale(.large)
                        .frame(width: 60, height: 40)
                }
                .foregroundColor(.themeColor40)
            }
            
            HStack (spacing: 10) {
                Button {
                    //action
                } label: {
                    Text("ÏàòÏ†ïÌïòÍ∏∞")
                        .frame(minWidth: 100, maxWidth: 500, maxHeight: 50)
                }
                .modifier(DetailTodoSheetModifier())
                
                Button {
                    //action - Ïò§Îäò
                    detailTodoViewModel.isDatePickerShowing.toggle()
                } label: {
                    Text("ÎÇ†Ïßú Î≥ÄÍ≤Ω")
                        .frame(minWidth: 100, maxWidth: 500, maxHeight: 50)
                }
                .modifier(DetailTodoSheetModifier())
//                .alert("ÎÇ†Ïßú Î≥ÄÍ≤Ω", isPresented: $detailTodoViewModel.isDatePickerShowing) {
//                    Button("ÌôïÏù∏") {
//                        detailTodoViewModel.isDetailSheetShowing.toggle()
//                        print("Ìà¨ÎëêÏùò ÎÇ†ÏßúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.") //ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ!!!
//                    }
//                    Button("Ï∑®ÏÜå", role: .cancel) { }
//                } message: {
//
//                }

            }
            
            Button {
                //action
            } label: {
                Text("Ìè¨Í∏∞ÌïòÍ∏∞")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Button {
                //action
            } label: {
                Text("ÎÇ¥Ïùº ÌïòÍ∏∞")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Button {
                //action
            } label: {
                Text("ÏÇ≠Ï†ú")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Spacer()
        }
        .padding(.horizontal, 20)
        .padding(.top, 30)
    }
}

//MARK: - ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÏãúÌä∏ (ÎØ∏Îûò)
struct DetailTodoOfFuture: View {
    @ObservedObject var detailTodoViewModel: DetailTodoViewModel
    
    init(_ detailTodoViewModel: DetailTodoViewModel) {
        self.detailTodoViewModel = detailTodoViewModel
    }
    
    var body: some View {
        VStack (spacing: 10) {
            // Ï†úÎ™©Í≥º Ï∑®ÏÜå Î≤ÑÌäº
            HStack {
                Text("ÏÉÅÏÑ∏ ÏÑ§Ï†ï")
                    .font(.title)
                Spacer()
                Button {
                    detailTodoViewModel.isDetailSheetShowing = false
                } label: {
                    Image(systemName: "xmark")
                        .imageScale(.large)
                        .frame(width: 60, height: 40)
                }
                .foregroundColor(.themeColor40)
            }
            
            HStack (spacing: 10) {
                Button {
                    //action
                } label: {
                    Text("ÏàòÏ†ïÌïòÍ∏∞")
                        .frame(minWidth: 100, maxWidth: 500, maxHeight: 50)
                }
                .modifier(DetailTodoSheetModifier())
                
                Button {
                    //action
                } label: {
                    Text("ÎÇ†Ïßú Î≥ÄÍ≤Ω")
                        .frame(minWidth: 100, maxWidth: 500, maxHeight: 50)
                }
                .modifier(DetailTodoSheetModifier())
            }
            
            Button {
                //action
            } label: {
                Text("Ìè¨Í∏∞ÌïòÍ∏∞")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Button {
                //action
            } label: {
                Text("Ïò§Îäò ÌïòÍ∏∞")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Button {
                //action
            } label: {
                Text("ÏÇ≠Ï†ú")
                    .frame(minWidth: 200, maxWidth: 1000, maxHeight: 50)
            }
            .modifier(DetailTodoSheetModifier())
            
            Spacer()
        }
        .padding(.horizontal, 20)
        .padding(.top, 30)
    }
}

struct DailyTodoView_Previews: PreviewProvider {
    static var previews: some View {
        DailyTodoView().environment(\.managedObjectContext, PersistenceController.preview.container.viewContext)
    }
}

//MARK: - ÏÉÅÏÑ∏ ÏÑ§Ï†ï ÏãúÌä∏ Î≤ÑÌäº Custom Modifier
struct DetailTodoSheetModifier: ViewModifier {
    func body(content: Content) -> some View {
        content
            .foregroundColor(.themeColor40)
            .cornerRadius(35)
            .overlay {
                Capsule()
                    .stroke(Color.themeColor40, lineWidth: 1)
            }
    }
}

//MARK: - Date Picker Alert
struct DatePickerAlert<Content: View>: View {
    let content: Content
    @ObservedObject var detailTodoViewModel: DetailTodoViewModel
    
    init(detailTodoViewModel: DetailTodoViewModel,
         @ViewBuilder content: () -> Content) {
        self.detailTodoViewModel = detailTodoViewModel
        self.content = content()
    }
    
    var body: some View {
        self.content
            .alert("Date Picker", isPresented: $detailTodoViewModel.isDatePickerShowing) {
                Button("OK") { }
            } message: {
                Text("This is date picker ...")
            }

    }
}
