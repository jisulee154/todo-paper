//
//  DailyTodoView.swift
//  todo-paper
//
//  Created by Ïù¥ÏßÄÏàò on 2023/07/07.
//

import SwiftUI
import CoreData
import Combine
import BottomSheet
import AlertToast


/// ÏùºÎ≥Ñ Ìà¨Îëê Î≥¥Í∏∞ ÌÉ≠
struct DailyTodoView: View {
    
    //MARK: - Shared Data
    @Environment(\.managedObjectContext) private var viewContext
    
//    @ObservedObject var todoViewModel: TodoViewModel = TodoViewModel()
    
    @ObservedObject var todoViewModel: TodoViewModel = TodoViewModel()
    @ObservedObject var detailTodoViewModel: DetailTodoViewModel = DetailTodoViewModel()
    @ObservedObject var stickerViewModel: StickerViewModel = StickerViewModel()
    @ObservedObject var settingViewModel: SettingViewModel
    
    init(todoViewModel: TodoViewModel, detailTodoViewModel: DetailTodoViewModel, stickerViewModel: StickerViewModel, settingViewModel: SettingViewModel) {
        self.todoViewModel = todoViewModel
        self.detailTodoViewModel = detailTodoViewModel
        self.stickerViewModel = stickerViewModel
        self.settingViewModel = settingViewModel
    }
    
    //MARK: - View
    var body: some View {
        ZStack {
            /// ÎÇ†Ïßú ÏÑ†ÌÉù Ïä§ÌÅ¨Î°§Í≥º Ìà¨Îëê Î¶¨Ïä§Ìä∏ Î™©Î°ù, Ïï± ÏÑ§Ï†ï
            makeTodoList()
                .zIndex(0)
            
            /// Ìà¨Îëê ÏÉùÏÑ±, Ïä§Ìã∞Ïª§ ÏÉùÏÑ± Î≤ÑÌäº
            makeAddButtonAndSticker()
                .zIndex(1)            
            
        }
        //MARK: - ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ
        .toast(isPresenting: $detailTodoViewModel.showDeletedToast) {
            AlertToast(displayMode: .hud, type: .regular, title: "Ìà¨ÎëêÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showPostponedToast) {
            AlertToast(displayMode: .hud, type: .complete(.green), title: "ÎÇ¥ÏùºÎèÑ Í∞ôÏùÄ Ìà¨ÎëêÎ•º Ï∂îÍ∞ÄÌñàÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showChangedAsTodayToast) {
            AlertToast(displayMode: .hud, type: .complete(.green), title: "Ïò§Îäò Î™©Î°ùÏúºÎ°ú ÏòÆÍ≤ºÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showAnotherDayToast) {
            AlertToast(displayMode: .hud, type: .complete(.green), title: "ÏÑ†ÌÉùÌïú ÏùºÏûêÎ°ú ÏòÆÍ≤ºÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showUnfinishedTodosToast) {
            AlertToast(displayMode: .hud, type: .regular, title: "ü•∫ ÎØ∏ÏôÑÎ£åÏù∏ Ìà¨ÎëêÍ∞Ä ÏûàÏñ¥\nÏôÑÎ£å Ïä§Ìã∞Ïª§Î•º Î∂ôÏùº Ïàò ÏóÜÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showCantPutStickerYet) {
            AlertToast(displayMode: .hud, type: .regular, title: "Ïò§ÎäòÍ≥º Ïù¥Ï†Ñ ÏùºÏûêÏóêÎßå\nÏôÑÎ£å Ïä§Ìã∞Ïª§Î•º Î∂ôÏùº Ïàò ÏûàÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showCantPutStickerNone) {
            AlertToast(displayMode: .hud, type: .regular, title: "Ïö∞ÏÑ† Ìà¨ÎëêÎ∂ÄÌÑ∞ Ï∂îÍ∞ÄÌï¥Î≥ºÍπåÏöî?")
        }
        .toast(isPresenting: $detailTodoViewModel.showCantPutStickerNonePast) {
            AlertToast(displayMode: .hud, type: .regular, title: "üòñ ÏôÑÎ£åÌïú Ìà¨ÎëêÍ∞Ä ÏóÜÏñ¥\nÏä§Ìã∞Ïª§Î•º Î∂ôÏùº Ïàò ÏóÜÏñ¥Ïöî.")
        }
        .toast(isPresenting: $detailTodoViewModel.showStickerDeletedToast) {
            AlertToast(displayMode: .hud, type: .regular, title: "Ïä§Ìã∞Ïª§Í∞Ä ÎñºÏñ¥Ï°åÏñ¥Ïöî.")
        }
        .confirmationDialog("ÏÑ§Ï†ï", isPresented: $todoViewModel.showEditAferCompleteAlert) {
            Button("Ïä§Ìã∞Ïª§ ÎñºÍ∏∞", role: .destructive) {
                detailTodoViewModel.showStickerDeletedToast.toggle()
                
                stickerViewModel.isTodayStickerOn = false
                
                stickerViewModel.sticker = stickerViewModel.fetchSticker(on: todoViewModel.searchDate)
                
                if let sticker = stickerViewModel.sticker {
                    stickerViewModel.deleteASticker(deletingSticker: sticker)
                    stickerViewModel.sticker = nil
                }
                
//                stickerViewModel.sticker = stickerViewModel.updateASticker(updatingSticker: stickerViewModel.sticker!, date: todoViewModel.searchDate, isExist: false, stickerName: nil, stickerBgColor: nil)
            }
            Button("Ï∑®ÏÜå", role: .cancel) {
                
            }
        } message: {
            Text("ÏôÑÎ£å Ïä§Ìã∞Ïª§Î•º ÎñºÍ≥† Îã§Ïãú ÏÑ§Ï†ïÌïòÏãúÍ≤†Ïñ¥Ïöî?")
        }

    }
    
    //MARK: - ÎÇ†Ïßú ÏÑ†ÌÉù Ïä§ÌÅ¨Î°§Í≥º Ìà¨Îëê Î¶¨Ïä§Ìä∏ Î™©Î°ù, Ïï± ÏÑ§Ï†ï
    private func makeTodoList() -> some View {
        VStack {
            ///Ï∫òÎ¶∞Îçî Ïä§ÌÅ¨Î°§ Î∂ÄÎ∂Ñ & Ïò§ÎäòÎ°ú Ïù¥Îèô & Ïï± ÏÑ§Ï†ï
            Header(todoViewModel: todoViewModel,
                   detailTodoViewModel: detailTodoViewModel,
                   stickerViewModel: stickerViewModel,
                   settingViewModel: settingViewModel)
            
            ZStack {
                /// - ÏôÑÎ£å Ïä§Ìã∞Ïª§ Î∂ÄÏ∞©
                if stickerViewModel.isTodayStickerOn && (stickerViewModel.sticker?.isExist ?? false){
                    makeSticker()
                        .contentShape(Circle())
                        .zIndex(1)
                }
                
                if (todoViewModel.todos.count > 0) || (todoViewModel.oldTodos.count > 0) {
                    VStack {
                        ///Ìà¨Îëê Î™©Î°ù Î∂ÄÎ∂Ñ
                        List {
                            if todoViewModel.todos.count > 0 {
                                Section("list") {
                                    VStack {
                                        ForEach(todoViewModel.todos) { todo in
                                            TodoItemRow(with: TodoItem(uuid: todo.uuid,
                                                                       title: todo.title,
                                                                       duedate: todo.duedate,
                                                                       status: todo.status,
                                                                       completeDate: todo.completeDate),
                                                        todoViewModel: todoViewModel,
                                                        todoItemRowType: TodoItemRowType.today,
                                                        detailTodoViewModel: detailTodoViewModel,
                                                        stickerViewModel: stickerViewModel,
                                                        settingViewModel: settingViewModel)
                                            Divider()
                                            
                                        }
                                    }
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 10, style: .circular).stroke(Color.themeColor40, lineWidth: 2)
                                    )
                                }
                                .listRowInsets(EdgeInsets.init())
                            }
                            
                            // Î≥¥Ïó¨ÏßÄÎäî ÏùºÏûêÍ∞Ä Ïò§ÎäòÏù∏ Í≤ΩÏö∞ Í∏∞ÌïúÏù¥ ÏßÄÎÇú Ìà¨ÎëêÎ•º old ÏÑπÏÖòÏóê Ï∂úÎ†•ÌïúÎã§.
                            if todoViewModel.canShowOldTodos() {
                                if todoViewModel.oldTodos.count != 0 {
                                    Section("old") {
                                        VStack {
                                            ForEach(todoViewModel.oldTodos) { todo in
                                                TodoItemRow(with: TodoItem(uuid: todo.uuid,
                                                                           title: todo.title,
                                                                           duedate: todo.duedate,
                                                                           status: todo.status,
                                                                           completeDate: todo.completeDate),
                                                            todoViewModel: todoViewModel,
                                                            todoItemRowType: TodoItemRowType.old,
                                                            detailTodoViewModel: detailTodoViewModel,
                                                            stickerViewModel: stickerViewModel,
                                                            settingViewModel: settingViewModel)
                                                
                                                Divider()
                                            }
                                        }
                                        .overlay(
                                            RoundedRectangle(cornerRadius: 10, style: .circular).stroke(Color.themeColor40, lineWidth: 2)
                                        )
                                    }.listRowInsets(EdgeInsets.init())
                                }
                            }
                            Color.clear.frame(height:100)
                                .listRowBackground(Color.clear)
                        } // List
                    }
                } else {
                    // Ìï¥Îãπ ÎÇ†ÏßúÏùò Ìà¨ÎëêÍ∞Ä ÏóÜÏùÑ Îïå
                    HStack {
                        Spacer()
                        VStack {
                            Spacer()
                            Text("""
                               ÏûëÏÑ±Îêú Ìà¨ÎëêÍ∞Ä ÏóÜÏñ¥Ïöî.\n
                               ÌïòÎÇò Ï∂îÍ∞ÄÌï¥ Î≥ºÍπåÏöî? üìù
                               """)
                            Spacer()
                        }
                        Spacer()
                    }
                    .overlay(
                        RoundedRectangle(cornerRadius: 15, style: .circular).stroke(Color.themeColor40, lineWidth: 1)
                    )
                    .padding(.all, 10)
                }
            }.zIndex(0)
        }
        // Ìï†Ïùº Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        .refreshable {
            todoViewModel.todos = todoViewModel.fetchTodosBySelectedDate(enableHideGaveUpTask: settingViewModel.enableHideGaveUpTask)
//            if settingViewModel.enableHideGaveUpTask {
//                // Ìè¨Í∏∞Ìïú Ïùº Ïà®Í∏∞Í∏∞ trueÏùº Îïå
//                todoViewModel.todos = todoViewModel.eraseCanceledTodo(of: todoViewModel.todos)
//            }
            
            if todoViewModel.canShowOldTodos() {
                todoViewModel.oldTodos = todoViewModel.fetchOldTodos(enableHideGaveUpTask: settingViewModel.enableHideGaveUpTask)
//                if settingViewModel.enableHideGaveUpTask {
//                    // Ìè¨Í∏∞Ìïú Ïùº Ïà®Í∏∞Í∏∞ trueÏùº Îïå
//                    todoViewModel.oldTodos = todoViewModel.eraseCanceledTodo(of: todoViewModel.oldTodos)
//                }
            }
        }
        .onAppear {
            UITableViewCell.appearance().selectionStyle = .none
            
            todoViewModel.searchDate = todoViewModel.setSearchDate(date: Date())
//            todoViewModel.scrollTargetDate = todoViewModel.setScrollTargetDate(with: Date())
            
            todoViewModel.todos = todoViewModel.fetchTodosBySelectedDate(enableHideGaveUpTask: settingViewModel.enableHideGaveUpTask)
//            if settingViewModel.enableHideGaveUpTask {
//                // Ìè¨Í∏∞Ìïú Ïùº Ïà®Í∏∞Í∏∞ trueÏùº Îïå
//                todoViewModel.todos = todoViewModel.eraseCanceledTodo(of: todoViewModel.todos)
//            }
            todoViewModel.oldTodos = todoViewModel.fetchOldTodos(enableHideGaveUpTask: settingViewModel.enableHideGaveUpTask)
//            if settingViewModel.enableHideGaveUpTask {
//                // Ìè¨Í∏∞Ìïú Ïùº Ïà®Í∏∞Í∏∞ trueÏùº Îïå
//                todoViewModel.oldTodos = todoViewModel.eraseCanceledTodo(of: todoViewModel.oldTodos)
//            }
            
            todoViewModel.isActivePutSticker = todoViewModel.getActivePutSticker(enableHideGaveUpTask: settingViewModel.enableHideGaveUpTask)
            
            // Ïä§Ìã∞Ïª§ Ï≤¥ÌÅ¨
            stickerViewModel.isTodayStickerOn = stickerViewModel.getTodayStickerOn(date: todoViewModel.searchDate)
            
            if stickerViewModel.isTodayStickerOn {
                stickerViewModel.sticker = stickerViewModel.fetchSticker(on: todoViewModel.searchDate)
            }
            
//            // Use this for inspecting the Core Data
//            if let directoryLocation = FileManager.default.urls(for: .libraryDirectory, in: .userDomainMask).last {
//                print("Documents Directory: \(directoryLocation)Application Support")
//            }
        }
    }
    
    //MARK: - Ìà¨Îëê ÏÉùÏÑ±, Ïä§Ìã∞Ïª§ ÏÉùÏÑ± Î≤ÑÌäº
    private func makeAddButtonAndSticker() -> some View {
        FloatingFooter(todoViewModel: todoViewModel, detailTodoViewModel: detailTodoViewModel, stickerViewModel: stickerViewModel, settingViewModel: settingViewModel)
    }
    
    
    
    //MARK: - Ïä§Ìã∞Ïª§
    private func makeSticker() -> some View {
        ZStack {
            Color.white
                .opacity(0.6)
                .zIndex(0)
                .onTapGesture {
                    todoViewModel.showEditAferCompleteAlert.toggle()
                }
            VStack {
                HStack {
                    Spacer()
                    Menu {
                        Button {
                            detailTodoViewModel.setStickerBottomSheetPosition = .relative(0.5)
                        } label: {
                            Text("Ïä§Ìã∞Ïª§ Î∞îÍæ∏Í∏∞")
                        }
                        
                        Button {
                            stickerViewModel.sticker = stickerViewModel.fetchSticker(on: todoViewModel.searchDate)
                            
                            if let sticker = stickerViewModel.sticker {
                                stickerViewModel.deleteASticker(deletingSticker: sticker)
                                stickerViewModel.sticker = nil
                            }
                            stickerViewModel.isTodayStickerOn = false
//                            stickerViewModel.sticker = stickerViewModel.updateASticker(updatingSticker: stickerViewModel.sticker!,
//                                                                                       date: todoViewModel.searchDate,
//                                                                                       isExist: false, stickerName: nil,
//                                                                                       stickerBgColor: nil)
                            
                        } label: {
                            Text("ÎñºÍ∏∞")
                        }
                        
                    } label: {
                        ZStack {
                            Circle()
                                .fill(Color.themeColor40)
                                .frame(width: 100, height: 100)
                            //                            .opacity(0.7)
                                .overlay {
                                    Circle()
                                        .stroke(Color.themeColor10, lineWidth: 0)
                                }
                                .shadow(color: Color.gray, radius: 10)
                                .zIndex(1)
                            Image(systemName: stickerViewModel.sticker?.stickerName ?? "checkmark.seal.fill")
                                .resizable()
                                .frame(width: 70, height: 70)
                                .foregroundColor(.white)
                                .zIndex(2)
                                .padding(.vertical, 10)
                            Image(systemName: "water.waves")
                                .resizable()
                                .frame(width: 100, height: 80)
                                .foregroundColor(.themeColor40)
                                .opacity(0.7)
                                .shadow(color: Color.gray, radius: 10)
                                .zIndex(0)
                                .padding(.leading, 50)
                                .padding(.top, 30)
                        }
                    }
                    .contentShape(Circle())
                    .background(Color.clear)
                    .frame(width: 50, height: 50)
                    .padding(.top, 50)
                    .padding(.trailing, 50)
                    .zIndex(1)
                }
                Spacer()
            }
        }
    }
    
}


////MARK: - Date Picker Alert
//struct DatePickerAlert<Content: View>: View {
//    let content: Content
//    @ObservedObject var detailTodoViewModel: DetailTodoViewModel
//
//    init(detailTodoViewModel: DetailTodoViewModel,
//         @ViewBuilder content: () -> Content) {
//        self.detailTodoViewModel = detailTodoViewModel
//        self.content = content()
//    }
//
//    var body: some View {
//        self.content
//            .alert("Date Picker", isPresented: $detailTodoViewModel.isDatePickerShowing) {
//                Button("OK") { }
//            } message: {
//                Text("This is date picker ...")
//            }
//
//    }
//}
